/**
 * Exchange public token generated by plaid-link on the client-side for a
 * server-side access_token that is stored on the user's database row for
 * future requests.
 *
 * @param  {[type]} models          Database models to make requests with
 * @param  {[type]} plaid           Plaid client to make requests with
 * @param  {[type]} public_token    Token sent to plaid in exchange for an access_token
 * @param  {[type]} user_id         User that the token should be assigned to
 * @return {[type]}                 The token that was created by the exchange process
 */
var exchangeToken = async function(models, plaid, user_id, public_token) {
    var result = { status: null, data: null };

    try {
        var exchangeResponse = await plaid.exchangeTokenAsync(public_token);

        var token = await models.PlaidToken.create({
            plaid_raw: JSON.stringify(exchangeResponse),
            user_id: user_id,
            access_token: await exchangeResponse.access_token
        });

    } catch(error) {
        console.error('Plaid error exchanging public for access token: ', error);

        result.status = 'erorr';
        result.data = error;

    } finally {
        console.log('Exchange Response: ', exchangeResponse);
        console.log('Token Created: ', token);

        result.status = 'success';
        result.data = token;
    }

    return await result;
};

var exchangeToken2 = function(models, plaid, user_id, public_token) {
    console.log('Exchange token called.');

    plaid.exchangeTokenAsync(public_token)
        .then(function(response) {
            console.log('Exchange Response: ', response);

            models.PlaidToken.create({
                plaid_raw: JSON.stringify(response),
                user_id: user_id,
                access_token: response.access_token

            }).then(function(token) {
                console.log('Token Created: ', token);

                return {
                    status: 'success',
                    data: token
                }
            });
        }).catch(function(error) {
            console.error('Plaid error exchanging public for access token: ', error);

            return {
                status: 'error',
                data: error
            }
        });
};

module.exports = exchangeToken;
